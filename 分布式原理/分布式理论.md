# 分布式原理

*互联网发展至今，为了应对更高的业务量、提供更优质的服务，后端从单体服务逐渐演进至当下主流的分布式架构。所谓分布式，通俗来说就是将一个大而全的服务，基于业务领域拆分为多个独立的子服务(低耦合、高内聚)，并针对每个子服务部署合适的实例，不通的实例在空间上是可以随意分布的。*

### 1、分布式理论

#### 1.1 一致性
- 强一致性
- 弱一致性
  - 读写一致性 
  - 单调读一致性
  - 因果一致性
  - 最终一致性

#### 1.2 CAP定理
- 一致性 Consistency
  - 在数据一致性抵达之前, 不对外提供服务
- 可用性 Availability
  - 在数据一致性抵达之前, 仍对外提供服务, 哪怕响应的为旧数据
- 分区容错性 Partition tolerance
  - 分区容错性 P 是分布式系统的前提, 因此只在CA之间做取舍, P 必须保留

#### 1.3 BASE理论
- 基本可用  BA - Basically Available
- 软状态    S - Soft state
- 最终一致性 E -  Eventually consistent

#### 1.4 分布式事务
- ACID 
  - A - Atomicity（原子性）
  - C - Consistency（一致性）
  - I - Isolation（隔离性）
  - D - Durablity（持久性）
- 分布式环境中多服务实例配合对外提供服务, 因此一次事务的提供涉及到多节点的读写操作, 跨节点操作无法基于数据库自身来满足ACID四大特性, 此时就需要分布式事务来实现跨节点操作操作事务

#### 1.5 一致性协议 - 2PC
- 两阶段提交(Two-Phase Commit)
  - 准备阶段(Prepare phase)
    - 事务管理器给每个参与者发送prepare请求, 每个参与者在本地执行事务但不提交(如: mysql写undo log和redo log, 但是不commit)
  - 提交阶段
    - 事务管理器收到参与者执行失败或者超时的信息, 直接给参与者发送rollback命令; 否则发送commit命令。参与者在接受到此命令后执行并释放事务处理过程中的锁资源.
- 2PC的优缺点
  - 优点: 原理简单、实现方便
  - 缺点: 同步阻塞、单点问题、数据不一致、太过保守
    - 同步阻塞: 所有参与者在等待其他参与者的响应的过程中无法执行别的操作, 这种同步阻塞极大的限制了分布式系统的性能
    - 单点问题: 协调者在整个二阶段提交过程很重要, 如果协调者在提交阶段出现问题, 整个流程将无法运转。其他参与者在未收到commit或rollback时, 将处于一直锁定事务资源的状态中, 而无法继续完成事务操作。
    - 数据不一致: 如果协调者给所有参与者发送了commit, 由于局部网络异常或协调者在发送完所有的commit前自身崩溃, 导致最终只有部分参与者接到commit命令提交事务, 这将导致严重的数据不一致问题。
    - 太过于保守: 如果参与者在提交阶段, 由于网络故障或者自身问题导致不能及时给到协调者响应, 协调者只能依靠自身的超时机制来判断是否需要中断事务。显然此种策略相对较为保守。缺乏较为完善的容错机制，任意节点的失败都会导致整个事务的失败。

#### 1.6 一致性协议 - 3PC

#### 1.7 一致性算法 - Paxos

#### 1.8 一致性算法 - Raft



### 2、分布式系统设计策略
- 心跳检测
- 高可用设计
- 容错性
- 负载均衡

### 3、分布式架构网络通信
- RPC
- RMI
- BIO、NIO、AIO
- Netty